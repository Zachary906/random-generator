<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Tests for Simple Wheel Test</title>
  <style>
    body { font-family: Arial, sans-serif; background:#111; color:#eee; padding:20px; }
    h1 { margin-top:0; }
    iframe { width:100%; height:320px; border:2px solid #444; background:#222; }
    table { width:100%; border-collapse:collapse; margin-top:20px; }
    th, td { padding:8px 10px; border:1px solid #333; font-size:14px; }
    th { background:#222; }
    .pass { background:#043d0b; color:#6eff8f; }
    .fail { background:#3d0404; color:#ff6e6e; }
    #summary { margin-top:15px; font-weight:bold; }
    .running { color:gold; }
    .done { color:#6eff8f; }
    code { background:#222; padding:2px 4px; border-radius:4px; }
  </style>
</head>
<body>
  <h1>Automated Tests: simple-test.html</h1>
  <p id="status" class="running">Status: Running...</p>
  <iframe id="appFrame" src="simple-test.html"></iframe>
  <div id="summary"></div>
  <table id="results">
    <thead>
      <tr><th>#</th><th>Test</th><th>Status</th><th>Details</th></tr>
    </thead>
    <tbody></tbody>
  </table>
<script>
(function() {
  const iframe = document.getElementById('appFrame');
  const resultsBody = document.querySelector('#results tbody');
  const summaryEl = document.getElementById('summary');
  const statusEl = document.getElementById('status');

  let passed = 0, failed = 0, testIndex = 0;
  const alertMessages = [];

  function recordResult(name, ok, detail) {
    testIndex++;
    const tr = document.createElement('tr');
    tr.className = ok ? 'pass' : 'fail';
    const statusText = ok ? 'PASS' : 'FAIL';
    tr.innerHTML = '<td>' + testIndex + '</td><td>' + name + '</td><td>' + statusText + '</td><td>' + (detail || '') + '</td>';
    resultsBody.appendChild(tr);
    if (ok) passed++; else failed++;
  }

  function assert(condition, message) {
    if (!condition) throw new Error(message);
  }

  function delay(ms) {
    return new Promise(res => setTimeout(res, ms));
  }

  const tests = [
    async function testWheelCount(win, doc) {
      const wheels = doc.querySelectorAll('.wheel-option');
      assert(wheels.length === 3, 'Expected 3 wheels, found ' + wheels.length);
    },
    async function testStartupLog(win, doc) {
      const debug = doc.getElementById('debug');
      const html = debug.innerHTML;
      ['Script loaded!', 'Click a wheel above', 'Found 3 wheels'].forEach(s =>
        assert(html.includes(s), 'Missing startup log: ' + s)
      );
    },
    async function testClickGen1(win, doc) {
      const debug = doc.getElementById('debug');
      const wheel = doc.querySelectorAll('.wheel-option')[0];
      wheel.click();
      await delay(20);
      assert(alertMessages.includes('Opening wheel for: 1'), 'Alert for gen1 not captured');
      assert(debug.innerHTML.includes('CLICKED: 1'), 'Debug missing CLICKED: 1');
    },
    async function testClickGen2(win, doc) {
      const debug = doc.getElementById('debug');
      const wheel = doc.querySelectorAll('.wheel-option')[1];
      wheel.click();
      await delay(20);
      assert(alertMessages.includes('Opening wheel for: 2'), 'Alert for gen2 not captured');
      assert(debug.innerHTML.includes('CLICKED: 2'), 'Debug missing CLICKED: 2');
    },
    async function testClickLegendary(win, doc) {
      const debug = doc.getElementById('debug');
      const wheel = doc.querySelectorAll('.wheel-option')[2];
      wheel.click();
      await delay(20);
      assert(alertMessages.includes('Opening wheel for: legendary'), 'Alert for legendary not captured');
      assert(debug.innerHTML.includes('CLICKED: legendary'), 'Debug missing CLICKED: legendary');
    },
    async function testAllClicksLogged(win, doc) {
      const debugHTML = doc.getElementById('debug').innerHTML;
      ['CLICKED: 1', 'CLICKED: 2', 'CLICKED: legendary'].forEach(s =>
        assert(debugHTML.includes(s), 'Missing log entry: ' + s)
      );
    },
    async function testOnclickAttributes(win, doc) {
      const wheels = doc.querySelectorAll('.wheel-option');
      const expected = ["openWheel('1')", "openWheel('2')", "openWheel('legendary')"];
      wheels.forEach((el, i) => {
        const attr = el.getAttribute('onclick') || '';
        assert(attr.includes(expected[i]), 'Wheel ' + (i+1) + ' onclick mismatch. Found: ' + attr);
      });
    }
  ];

  iframe.addEventListener('load', async () => {
    try {
      const win = iframe.contentWindow;
      const doc = iframe.contentDocument;

      // Override alert to capture messages
      const originalAlert = win.alert;
      win.alert = function(msg) {
        alertMessages.push(msg);
        // Suppress actual dialog for test speed
      };

      for (const t of tests) {
        const name = t.name || 'Unnamed Test';
        try {
          await t(win, doc);
          recordResult(name, true, '');
        } catch (err) {
          recordResult(name, false, err.message);
        }
      }
      statusEl.textContent = 'Status: Completed';
      statusEl.className = 'done';
    } catch (e) {
      recordResult('Global Setup', false, e.message);
      statusEl.textContent = 'Status: Aborted';
      statusEl.className = 'fail';
    } finally {
      summaryEl.textContent = 'Summary: ' + passed + ' passed / ' + failed + ' failed / ' + testIndex + ' total';
      window.scrollTo(0, document.body.scrollHeight);
    }
  });
})();
</script>
</body>
</html>
